image:
  name: docker/compose:1.23.2
  entrypoint: ["sh", "-c"]
services:
  - name: docker:dind
    alias: docker
    command: [
      "--mtu", "1400", # https://github.com/docker-library/docker/issues/103
      "--dns", "8.8.8.8",
      "--dns-search", "lan"
    ]
variables:
  DOCKER_HOST: tcp://docker:2375
  # When using dind, it's wise to use the overlayfs driver for
  # improved performance.
  # See also: https://docs.gitlab.com/ce/ci/docker/using_docker_build.html
  DOCKER_DRIVER: overlay2

# global *_script will overwrite by job defined *_script
before_script:
  - |
    # Ensuring network...
    if [[ -f /etc/alpine-release ]]; then
      # Handle search domain error
      # see also: https://github.com/jetstack/cert-manager/issues/1161
      if [[ "$(grep 'search' /etc/resolv.conf | awk '{print NF}')" -ge 5 ]]; then
        echo "$(sed -e '/nameserver/!d' /etc/resolv.conf)" > /etc/resolv.conf
      fi
    fi
  - eval "$(wget -qO- https://arp.to/@ci/scripts/before.sh)"
after_script:
  - eval "$(wget -qO- https://arp.to/@ci/scripts/after.sh)"
